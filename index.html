<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deteksi Jentik Nyamuk</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px}
    #container{max-width:420px;width:100%;display:flex;flex-direction:column;align-items:center;gap:8px}
    video, canvas{width:100%;height:auto;border-radius:8px;background:#000}
    button{padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:white;font-weight:600}
    #msg{font-size:0.9rem;color:#444}
  </style>
</head>
<body>
  <h2>Deteksi Jentik Nyamuk</h2>
  <div id="container">
    <!-- Video (live camera) -->
    <video id="video" autoplay playsinline></video>
    <!-- Canvas untuk menampilkan hasil capture / deteksi. Awalnya tersembunyi -->
    <canvas id="canvas" style="display:none"></canvas>

    <div style="display:flex;gap:8px;width:100%">
      <button id="btnCapture">Capture & Deteksi</button>
      <button id="btnReset" style="background:#ef4444;">Reset</button>
    </div>
    <div id="msg">Pastikan file <code>cascade.xml</code> berada di folder yang sama dengan file HTML ini.</div>
  </div>

  <!-- OpenCV.js (russian CDN or official) -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" ></script>
  <script>
    // Elemen DOM
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const btnCapture = document.getElementById('btnCapture');
    const btnReset = document.getElementById('btnReset');
    const msg = document.getElementById('msg');

    let stream = null;
    let classifier = null;
    let cascadeLoaded = false;

    // Minta akses kamera belakang (environment). Jika gagal, coba tanpa exact.
    async function startCamera(){
      const constraintsList = [
        { video: { facingMode: { exact: 'environment' } }, audio: false },
        { video: { facingMode: 'environment' }, audio: false },
        { video: true, audio: false }
      ];
      for (const c of constraintsList){
        try{
          stream = await navigator.mediaDevices.getUserMedia(c);
          video.srcObject = stream;
          return;
        }catch(e){
          // lanjutkan ke opsi berikut
        }
      }
      throw new Error('Tidak dapat mengakses kamera');
    }

    // Muat cascade.xml ke file system OpenCV.js
    async function loadCascadeToFS(url='cascade.xml'){
      try{
        const res = await fetch(url);
        if (!res.ok) throw new Error('fetch gagal: '+res.status);
        const buf = await res.arrayBuffer();
        // buat file di virtual FS
        const data = new Uint8Array(buf);
        cv.FS_createDataFile('/', 'cascade.xml', data, true, false, false);
        cascadeLoaded = true;
        console.log('cascade dimuat ke FS');
      }catch(err){
        cascadeLoaded = false;
        console.error('Gagal load cascade:', err);
        msg.textContent = 'Gagal memuat cascade.xml â€” cek file ada di server dan nama tepat (cascade.xml)';
      }
    }

    // Inisialisasi OpenCV saat runtime siap
    function onOpenCvReady(){
      if (cv.getBuildInformation) console.log(cv.getBuildInformation());
      msg.textContent = 'OpenCV siap. Memuat cascade...';
      loadCascadeToFS().then(()=>{
        try{
          classifier = new cv.CascadeClassifier();
          const loaded = classifier.load('cascade.xml');
          if (!loaded) throw new Error('classifier.load returned false');
          msg.textContent = 'Cascade siap. Arahkan kamera ke objek lalu tekan Capture.';
        }catch(err){
          console.error(err);
          msg.textContent = 'Gagal membuat CascadeClassifier. Pastikan cascade.xml kompatibel dengan OpenCV.';
        }
      });
    }

    // Fungsi capture dan deteksi
    function captureAndDetect(){
      // set ukuran canvas sesuai video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Buat Mat dari canvas
      let src = cv.imread(canvas);
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
      // optional: equalize
      cv.equalizeHist(gray, gray);

      // detect
      let objects = new cv.RectVector();
      let msize = new cv.Size(20, 20);
      try{
        classifier.detectMultiScale(gray, objects, 1.1, 5, 0, msize, msize);
      }catch(err){
        console.error('detectMultiScale error', err);
        msg.textContent = 'Error saat deteksi: lihat console.';
      }

      // Gambar kotak hasil deteksi
      for (let i = 0; i < objects.size(); ++i) {
        let rect = objects.get(i);
        let point1 = new cv.Point(rect.x, rect.y);
        let point2 = new cv.Point(rect.x + rect.width, rect.y + rect.height);
        cv.rectangle(src, point1, point2, new cv.Scalar(255, 0, 0, 255), 3);
      }

      // Tampilkan di canvas
      cv.imshow(canvas, src);

      // Bersihkan
      src.delete(); gray.delete(); objects.delete(); msize = null;

      // Sembunyikan video, tampilkan canvas (hasil)
      video.style.display = 'none';
      canvas.style.display = 'block';
    }

    // Reset ke tampilan live
    function resetView(){
      if (video.srcObject){
        video.style.display = 'block';
        canvas.style.display = 'none';
        msg.textContent = 'Kembali ke tampilan kamera. Tekan Capture untuk mendeteksi lagi.';
      }
    }

    // Tombol
    btnCapture.addEventListener('click', ()=>{
      if (!cascadeLoaded || !classifier){
        msg.textContent = 'Cascade belum ter-load. Tunggu sebentar atau periksa console.';
        return;
      }
      captureAndDetect();
    });
    btnReset.addEventListener('click', resetView);

    // Start everything setelah halaman dimuat dan OpenCV siap
    (async ()=>{
      try{
        await startCamera();
      }catch(e){
        msg.textContent = 'Tidak dapat membuka kamera: ' + e.message;
        console.error(e);
      }

      // Jika OpenCV belum siap, set callback
      if (typeof cv === 'undefined'){
        msg.textContent = 'Menunggu OpenCV...';
        // onRuntimeInitialized akan dipanggil oleh opencv.js
        window.onOpenCvReady = onOpenCvReady;
      }else{
        // Jika already loaded
        onOpenCvReady();
      }
    })();

    // opencv.js biasanya memanggil cv['onRuntimeInitialized'] when ready
    if (typeof cv !== 'undefined') cv['onRuntimeInitialized'] = onOpenCvReady;
    else window.addEventListener('opencvready', onOpenCvReady);

    // berhenti stream saat tab ditutup
    window.addEventListener('beforeunload', ()=>{
      if (stream){
        stream.getTracks().forEach(t => t.stop());
      }
    });
  </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"482454aa04f3496d8f86a76504db9bcf","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
